name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Qt 5.15.2
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1
    
    - name: Configure CMake
      run: |
        cmake -B build -S . `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt5_DIR" `
          -G "Visual Studio 17 2022" `
          -A x64
    
    - name: Build
      run: cmake --build build --config Release --parallel
    
    - name: Create release directory
      run: |
        mkdir release
    
    - name: Copy executable and resources
      run: |
        copy build\Release\DataUploadTool.exe release\
        if (Test-Path "logo.png") {
          copy logo.png release\
        }
        Write-Host "已复制可执行文件和资源文件" -ForegroundColor Green
    
    - name: Package with windeployqt
      working-directory: release
      run: |
        # 使用 windeployqt 部署所有依赖，包括网络插件
        & "$env:Qt5_DIR\bin\windeployqt.exe" --compiler-runtime --network DataUploadTool.exe
        Write-Host "windeployqt 完成，检查部署的文件..." -ForegroundColor Green
        
        # 检查关键文件是否存在
        if (Test-Path "platforms\qwindows.dll") {
          Write-Host "✓ platforms 目录已部署" -ForegroundColor Green
        }
        
        # 检查网络插件目录
        if (Test-Path "networkinformation") {
          Write-Host "✓ networkinformation 插件已部署" -ForegroundColor Green
        }
        
        # 列出所有目录
        Write-Host "已部署的插件目录:" -ForegroundColor Cyan
        Get-ChildItem -Directory | ForEach-Object { Write-Host "  - $($_.Name)" -ForegroundColor Cyan }
    
    - name: Copy OpenSSL DLL files
      run: |
        # 优先从项目的 dll 目录复制 OpenSSL DLL 文件
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "复制 OpenSSL DLL 文件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        $Copied = $false
        
        # 方法1: 优先从项目 dll 目录复制（最可靠）
        if ((Test-Path "dll\libcrypto-1_1.dll") -and (Test-Path "dll\libssl-1_1.dll")) {
          Copy-Item "dll\libcrypto-1_1.dll" -Destination "release\" -Force
          Copy-Item "dll\libssl-1_1.dll" -Destination "release\" -Force
          Write-Host "已从项目 dll 目录复制 OpenSSL DLL" -ForegroundColor Green
          Write-Host "  - libcrypto-1_1.dll" -ForegroundColor Green
          Write-Host "  - libssl-1_1.dll" -ForegroundColor Green
          $Copied = $true
        } else {
          Write-Host "项目 dll 目录中未找到 OpenSSL DLL" -ForegroundColor Yellow
          
          # 方法2: 尝试从 Qt 目录复制
          $QtBin = "$env:Qt5_DIR\bin"
          Write-Host "尝试从 Qt 目录复制: $QtBin" -ForegroundColor Cyan
          
          $libcrypto = Get-ChildItem -Path $QtBin -Filter "libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          $libssl = Get-ChildItem -Path $QtBin -Filter "libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($libcrypto -and $libssl) {
            Copy-Item $libcrypto.FullName -Destination "release\" -Force
            Copy-Item $libssl.FullName -Destination "release\" -Force
            Write-Host "已从 Qt 目录复制 OpenSSL DLL" -ForegroundColor Green
            Write-Host "  - $($libcrypto.Name)" -ForegroundColor Green
            Write-Host "  - $($libssl.Name)" -ForegroundColor Green
            $Copied = $true
          }
        }
        
        # 验证 DLL 文件是否已复制
        if ($Copied) {
          $libcrypto = Get-ChildItem -Path "release" -Filter "libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          $libssl = Get-ChildItem -Path "release" -Filter "libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($libcrypto -and $libssl) {
            Write-Host "========================================" -ForegroundColor Green
            Write-Host "OpenSSL DLL 文件验证成功:" -ForegroundColor Green
            Write-Host "  - $($libcrypto.Name) ($([math]::Round($libcrypto.Length/1KB, 2)) KB)" -ForegroundColor Green
            Write-Host "  - $($libssl.Name) ($([math]::Round($libssl.Length/1KB, 2)) KB)" -ForegroundColor Green
            Write-Host "========================================" -ForegroundColor Green
            
            # 验证 DLL 文件架构（64位）
            Write-Host "验证 DLL 文件架构..." -ForegroundColor Cyan
            $fileInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($libcrypto.FullName)
            Write-Host "DLL 文件位置: $($libcrypto.FullName)" -ForegroundColor Cyan
          } else {
            Write-Host "警告: DLL 文件可能未正确复制" -ForegroundColor Yellow
            exit 1
          }
        } else {
          Write-Host "========================================" -ForegroundColor Red
          Write-Host "错误: 无法找到 OpenSSL DLL 文件" -ForegroundColor Red
          Write-Host "请确保项目 dll 目录包含 libcrypto-1_1.dll 和 libssl-1_1.dll" -ForegroundColor Red
          Write-Host "========================================" -ForegroundColor Red
          exit 1
        }
        
        # 检查 Qt 网络插件
        Write-Host "检查 Qt 网络插件..." -ForegroundColor Cyan
        $QtPlugins = "$env:Qt5_DIR\plugins"
        if (Test-Path "$QtPlugins\networkinformation") {
          Write-Host "找到 Qt 网络插件目录，复制到 release..." -ForegroundColor Green
          Copy-Item "$QtPlugins\networkinformation" -Destination "release\" -Recurse -Force -ErrorAction SilentlyContinue
        }
        
        # 确保 DLL 文件在正确位置（与 exe 同目录）
        Write-Host "最终验证: DLL 文件位置" -ForegroundColor Cyan
        $finalCrypto = Get-Item "release\libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        $finalSsl = Get-Item "release\libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($finalCrypto -and $finalSsl) {
          Write-Host "✓ $($finalCrypto.Name) 在 release 目录" -ForegroundColor Green
          Write-Host "✓ $($finalSsl.Name) 在 release 目录" -ForegroundColor Green
        }
    
    - name: Create portable package
      run: |
        # 创建便携版压缩包（包含所有依赖）
        Compress-Archive -Path release\* -DestinationPath DataUploadTool-Portable.zip -Force
        Write-Host "已创建便携版压缩包: DataUploadTool-Portable.zip" -ForegroundColor Green
        Write-Host "要创建单个 exe 文件，请使用 Enigma Virtual Box 或参考 PACKAGING.md" -ForegroundColor Yellow
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DataUploadTool-Windows-EXE
        path: |
          release/*
          DataUploadTool-Portable.*
        retention-days: 30

