name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install Qt 5.12.12 with aqt
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "安装 Qt 5.12.12" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        pip install aqtinstall
        
        # Qt 5.12.12 不需要 TLS 插件，可以直接使用 OpenSSL DLL
        Write-Host "使用 aqt 安装 Qt 5.12.12..." -ForegroundColor Cyan
        aqt install-qt windows desktop 5.12.12 win64_msvc2017_64
        
        # 设置环境变量
        $qtPath = Join-Path $PWD "5.12.12\msvc2017_64"
        Write-Host "Qt 安装路径: $qtPath" -ForegroundColor Green
        echo "Qt5_DIR=$qtPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        # 验证安装
        Write-Host "`n验证 Qt 安装:" -ForegroundColor Cyan
        if (Test-Path "$qtPath\bin\qmake.exe") {
          Write-Host "✓ qmake.exe 存在" -ForegroundColor Green
        }
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "✓ Qt 5.12.12 安装完成" -ForegroundColor Green
        Write-Host "  此版本不需要 TLS 插件即可使用 OpenSSL" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Green
    
    - name: Configure OpenSSL for Qt 5.12
      run: |
        Write-Host "配置 OpenSSL DLL..." -ForegroundColor Cyan
        
        # Qt 5.12 可以直接使用 OpenSSL DLL，无需插件
        # 将 OpenSSL DLL 复制到 Qt bin 目录
        $qtBin = "$env:Qt5_DIR\bin"
        
        if (Test-Path "dll\libcrypto-1_1-x64.dll") {
          Copy-Item "dll\libcrypto-1_1-x64.dll" -Destination "$qtBin\libcrypto-1_1-x64.dll" -Force
          Copy-Item "dll\libssl-1_1-x64.dll" -Destination "$qtBin\libssl-1_1-x64.dll" -Force
          Copy-Item "dll\libcrypto-1_1-x64.dll" -Destination "$qtBin\libcrypto-1_1.dll" -Force
          Copy-Item "dll\libssl-1_1-x64.dll" -Destination "$qtBin\libssl-1_1.dll" -Force
          Write-Host "✓ OpenSSL DLL 配置完成" -ForegroundColor Green
        }
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1
    
    - name: Configure CMake
      run: |
        Write-Host "配置 CMake..." -ForegroundColor Cyan
        cmake -B build -S . `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt5_DIR" `
          -G "Visual Studio 17 2022" `
          -A x64
        Write-Host "✓ CMake 配置完成" -ForegroundColor Green
    
    - name: Build
      run: cmake --build build --config Release --parallel
    
    - name: Create release directory
      run: |
        mkdir release
    
    - name: Copy executable and resources
      run: |
        copy build\Release\DataUploadTool.exe release\
        if (Test-Path "logo.png") {
          copy logo.png release\
        }
        Write-Host "已复制可执行文件和资源文件" -ForegroundColor Green
    
    - name: Package with windeployqt
      working-directory: release
      run: |
        # 使用 windeployqt 部署所有依赖
        # 注意: windeployqt 会自动部署 SSL 插件（如果存在）
        Write-Host "使用 windeployqt 部署依赖..." -ForegroundColor Cyan
        & "$env:Qt5_DIR\bin\windeployqt.exe" --compiler-runtime --network DataUploadTool.exe 2>&1 | Out-Null
        Write-Host "windeployqt 完成，检查部署的文件..." -ForegroundColor Green
        
        # 检查关键文件是否存在
        if (Test-Path "platforms\qwindows.dll") {
          Write-Host "✓ platforms 目录已部署" -ForegroundColor Green
        } else {
          Write-Host "警告: platforms 目录未找到" -ForegroundColor Yellow
        }
        
        # 检查网络插件目录
        if (Test-Path "plugins\networkinformation") {
          Write-Host "✓ networkinformation 插件已部署" -ForegroundColor Green
        } else {
          Write-Host "警告: networkinformation 插件未找到" -ForegroundColor Yellow
        }
        
        # 检查 SSL 插件目录（关键！）
        if (Test-Path "plugins\ssl") {
          Write-Host "✓ SSL 插件目录已部署" -ForegroundColor Green
          Get-ChildItem -Path "plugins\ssl" -Filter "*.dll" | ForEach-Object {
            Write-Host "  - $($_.Name)" -ForegroundColor Cyan
          }
        } else {
          Write-Host "警告: SSL 插件目录未找到，将在后续步骤中手动复制" -ForegroundColor Yellow
        }
        
        # 列出所有插件目录
        Write-Host "已部署的插件目录:" -ForegroundColor Cyan
        if (Test-Path "plugins") {
          Get-ChildItem -Path "plugins" -Directory | ForEach-Object { 
            Write-Host "  - plugins\$($_.Name)" -ForegroundColor Cyan 
          }
        }
    
    - name: Copy OpenSSL DLL files
      run: |
        # 优先从项目的 dll 目录复制 OpenSSL DLL 文件
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "复制 OpenSSL DLL 文件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        $Copied = $false
        
        # 方法1: 优先从项目 dll 目录复制（支持新的 x64 命名格式）
        # 首先尝试查找新的 x64 命名格式文件
        if ((Test-Path "dll\libcrypto-1_1-x64.dll") -and (Test-Path "dll\libssl-1_1-x64.dll")) {
          # 复制新格式文件并重命名为标准名称
          Copy-Item "dll\libcrypto-1_1-x64.dll" -Destination "release\libcrypto-1_1.dll" -Force
          Copy-Item "dll\libssl-1_1-x64.dll" -Destination "release\libssl-1_1.dll" -Force
          Write-Host "已从项目 dll 目录复制 OpenSSL DLL (x64版本，已重命名为标准名称)" -ForegroundColor Green
          Write-Host "  - libcrypto-1_1-x64.dll -> libcrypto-1_1.dll" -ForegroundColor Green
          Write-Host "  - libssl-1_1-x64.dll -> libssl-1_1.dll" -ForegroundColor Green
          $Copied = $true
        } elseif ((Test-Path "dll\64\libcrypto-1_1.dll") -and (Test-Path "dll\64\libssl-1_1.dll")) {
          # 方法1b: 从 dll/64 目录复制（64位版本，最可靠）
          Copy-Item "dll\64\libcrypto-1_1.dll" -Destination "release\" -Force
          Copy-Item "dll\64\libssl-1_1.dll" -Destination "release\" -Force
          Write-Host "已从项目 dll/64 目录复制 OpenSSL DLL (64位版本)" -ForegroundColor Green
          Write-Host "  - libcrypto-1_1.dll" -ForegroundColor Green
          Write-Host "  - libssl-1_1.dll" -ForegroundColor Green
          $Copied = $true
        } elseif ((Test-Path "dll\libcrypto-1_1.dll") -and (Test-Path "dll\libssl-1_1.dll")) {
          # 方法1c: 从 dll 目录复制标准名称文件（备用）
          Copy-Item "dll\libcrypto-1_1.dll" -Destination "release\" -Force
          Copy-Item "dll\libssl-1_1.dll" -Destination "release\" -Force
          Write-Host "已从项目 dll 目录复制 OpenSSL DLL" -ForegroundColor Green
          Write-Host "  - libcrypto-1_1.dll" -ForegroundColor Green
          Write-Host "  - libssl-1_1.dll" -ForegroundColor Green
          $Copied = $true
        } else {
          Write-Host "项目 dll 目录中未找到 OpenSSL DLL" -ForegroundColor Yellow
          
          # 方法2: 尝试从 Qt 目录复制
          $QtBin = "$env:Qt5_DIR\bin"
          Write-Host "尝试从 Qt 目录复制: $QtBin" -ForegroundColor Cyan
          
          $libcrypto = Get-ChildItem -Path $QtBin -Filter "libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          $libssl = Get-ChildItem -Path $QtBin -Filter "libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($libcrypto -and $libssl) {
            Copy-Item $libcrypto.FullName -Destination "release\" -Force
            Copy-Item $libssl.FullName -Destination "release\" -Force
            Write-Host "已从 Qt 目录复制 OpenSSL DLL" -ForegroundColor Green
            Write-Host "  - $($libcrypto.Name)" -ForegroundColor Green
            Write-Host "  - $($libssl.Name)" -ForegroundColor Green
            $Copied = $true
          }
        }
        
        # 验证 DLL 文件是否已复制
        if ($Copied) {
          $libcrypto = Get-ChildItem -Path "release" -Filter "libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          $libssl = Get-ChildItem -Path "release" -Filter "libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($libcrypto -and $libssl) {
            Write-Host "========================================" -ForegroundColor Green
            Write-Host "OpenSSL DLL 文件验证成功:" -ForegroundColor Green
            Write-Host "  - $($libcrypto.Name) ($([math]::Round($libcrypto.Length/1KB, 2)) KB)" -ForegroundColor Green
            Write-Host "  - $($libssl.Name) ($([math]::Round($libssl.Length/1KB, 2)) KB)" -ForegroundColor Green
            Write-Host "========================================" -ForegroundColor Green
            
            # 验证 DLL 文件架构（64位）
            Write-Host "验证 DLL 文件架构..." -ForegroundColor Cyan
            $fileInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($libcrypto.FullName)
            Write-Host "DLL 文件位置: $($libcrypto.FullName)" -ForegroundColor Cyan
          } else {
            Write-Host "警告: DLL 文件可能未正确复制" -ForegroundColor Yellow
            exit 1
          }
        } else {
          Write-Host "========================================" -ForegroundColor Red
          Write-Host "错误: 无法找到 OpenSSL DLL 文件" -ForegroundColor Red
          Write-Host "请确保项目 dll 目录包含以下文件之一:" -ForegroundColor Red
          Write-Host "  - libcrypto-1_1-x64.dll 和 libssl-1_1-x64.dll" -ForegroundColor Red
          Write-Host "  - libcrypto-1_1.dll 和 libssl-1_1.dll" -ForegroundColor Red
          Write-Host "========================================" -ForegroundColor Red
          exit 1
        }
        
        # 检查并复制 Qt SSL/TLS 插件（关键！）
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "检查并复制 Qt SSL/TLS 插件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        $QtPlugins = "$env:Qt5_DIR\plugins"
        $sslPluginCopied = $false
        
        # 方法1: 检查 windeployqt 是否已经部署了 SSL 或 TLS 插件
        # 检查 plugins/ssl 目录
        if (Test-Path "release\plugins\ssl") {
          $existingPlugins = Get-ChildItem -Path "release\plugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($existingPlugins -and $existingPlugins.Count -gt 0) {
            Write-Host "✓ windeployqt 已部署 SSL 插件 ($($existingPlugins.Count) 个)" -ForegroundColor Green
            foreach ($plugin in $existingPlugins) {
              Write-Host "  - $($plugin.Name)" -ForegroundColor Green
            }
            $sslPluginCopied = $true
          }
        }
        
        # 检查 plugins/tls 目录（Qt 5.15+ 可能使用这个目录）
        if ((Test-Path "release\plugins\tls") -and -not $sslPluginCopied) {
          $existingPlugins = Get-ChildItem -Path "release\plugins\tls" -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($existingPlugins -and $existingPlugins.Count -gt 0) {
            Write-Host "✓ windeployqt 已部署 TLS 插件 ($($existingPlugins.Count) 个)" -ForegroundColor Green
            foreach ($plugin in $existingPlugins) {
              Write-Host "  - $($plugin.Name)" -ForegroundColor Green
            }
            $sslPluginCopied = $true
          }
        }
        
        # 方法2: 如果 windeployqt 没有部署，手动从 Qt 目录复制
        if (-not $sslPluginCopied) {
          Write-Host "windeployqt 未部署 SSL 插件，尝试手动复制..." -ForegroundColor Yellow
          Write-Host "Qt 安装目录: $env:Qt5_DIR" -ForegroundColor Cyan
          Write-Host "Qt 插件目录: $QtPlugins" -ForegroundColor Cyan
          
          # 尝试从 plugins/ssl 目录复制
          if (Test-Path "$QtPlugins\ssl") {
            if (-not (Test-Path "release\plugins\ssl")) {
              New-Item -ItemType Directory -Path "release\plugins\ssl" -Force | Out-Null
              Write-Host "已创建 plugins\ssl 目录" -ForegroundColor Green
            }
            
            $sslPlugins = Get-ChildItem -Path "$QtPlugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
            if ($sslPlugins) {
              $copiedCount = 0
              foreach ($plugin in $sslPlugins) {
                $destPath = "release\plugins\ssl\$($plugin.Name)"
                Copy-Item $plugin.FullName -Destination $destPath -Force
                Write-Host "✓ 已复制 SSL 插件: $($plugin.Name)" -ForegroundColor Green
                $copiedCount++
              }
              Write-Host "共复制 $copiedCount 个 SSL 插件文件" -ForegroundColor Green
              $sslPluginCopied = $true
            }
          }
          
          # 尝试从 plugins/tls 目录复制（Qt 5.15+ 可能使用这个）
          if ((Test-Path "$QtPlugins\tls") -and -not $sslPluginCopied) {
            if (-not (Test-Path "release\plugins\tls")) {
              New-Item -ItemType Directory -Path "release\plugins\tls" -Force | Out-Null
              Write-Host "已创建 plugins\tls 目录" -ForegroundColor Green
            }
            
            $tlsPlugins = Get-ChildItem -Path "$QtPlugins\tls" -Filter "*.dll" -ErrorAction SilentlyContinue
            if ($tlsPlugins) {
              $copiedCount = 0
              foreach ($plugin in $tlsPlugins) {
                $destPath = "release\plugins\tls\$($plugin.Name)"
                Copy-Item $plugin.FullName -Destination $destPath -Force
                Write-Host "✓ 已复制 TLS 插件: $($plugin.Name)" -ForegroundColor Green
                $copiedCount++
              }
              Write-Host "共复制 $copiedCount 个 TLS 插件文件" -ForegroundColor Green
              $sslPluginCopied = $true
            }
          }
          
          if (-not $sslPluginCopied) {
            Write-Host "警告: 未找到 Qt SSL/TLS 插件目录" -ForegroundColor Yellow
            Write-Host "检查 Qt 插件目录是否存在:" -ForegroundColor Yellow
            if (Test-Path $QtPlugins) {
              Write-Host "Qt 插件目录存在: $QtPlugins" -ForegroundColor Yellow
              Write-Host "可用插件目录:" -ForegroundColor Yellow
              Get-ChildItem -Path $QtPlugins -Directory | ForEach-Object {
                Write-Host "  - $($_.Name)" -ForegroundColor Yellow
              }
            } else {
              Write-Host "Qt 插件目录不存在: $QtPlugins" -ForegroundColor Red
            }
            
            # 方法3: 尝试从其他可能的位置查找 SSL 插件
            Write-Host "尝试查找其他位置的 SSL 插件..." -ForegroundColor Yellow
            $possiblePaths = @(
              "$env:Qt5_DIR\bin\plugins\ssl",
              "$env:Qt5_DIR\lib\plugins\ssl",
              "$env:Qt5_DIR\..\..\plugins\ssl"
            )
            
            foreach ($path in $possiblePaths) {
              if (Test-Path $path) {
                Write-Host "在备用位置找到 SSL 插件: $path" -ForegroundColor Green
                if (-not (Test-Path "release\plugins\ssl")) {
                  New-Item -ItemType Directory -Path "release\plugins\ssl" -Force | Out-Null
                }
                $sslPlugins = Get-ChildItem -Path $path -Filter "*.dll" -ErrorAction SilentlyContinue
                if ($sslPlugins) {
                  foreach ($plugin in $sslPlugins) {
                    $destPath = "release\plugins\ssl\$($plugin.Name)"
                    Copy-Item $plugin.FullName -Destination $destPath -Force
                    Write-Host "✓ 已复制 SSL 插件: $($plugin.Name)" -ForegroundColor Green
                  }
                  $sslPluginCopied = $true
                  break
                }
              }
            }
          }
        }
        
        # 最终验证：如果仍然没有 SSL 插件，给出警告但不退出
        if (-not $sslPluginCopied) {
          Write-Host "========================================" -ForegroundColor Yellow
          Write-Host "警告: 无法找到 Qt SSL 插件" -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Yellow
          Write-Host "Qt 5.15.2 的 SSL 插件在某些分发版中不包含" -ForegroundColor Yellow
          Write-Host "这是正常的，对于 HTTPS 支持：" -ForegroundColor Yellow
          Write-Host "  - Qt 5.15.2 主要依赖 OpenSSL DLL 文件（已复制）" -ForegroundColor Yellow
          Write-Host "  - SSL 插件 (qopensslbackend.dll) 是可选的" -ForegroundColor Yellow
          Write-Host "  - 只要 OpenSSL DLL 存在，HTTPS 功能应该可以工作" -ForegroundColor Yellow
          Write-Host "" -ForegroundColor Yellow
          Write-Host "如果 HTTPS 仍然不工作，可以尝试：" -ForegroundColor Yellow
          Write-Host "1. 从完整的 Qt 5.15.2 安装中复制 plugins\tls 目录" -ForegroundColor Yellow
          Write-Host "2. 使用 Qt 在线安装器安装包含 SSL 支持的版本" -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Yellow
          # 不退出，允许构建继续
        } else {
          # 验证复制的文件
          $copiedPlugins = Get-ChildItem -Path "release\plugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($copiedPlugins -and $copiedPlugins.Count -gt 0) {
            Write-Host "验证: 在 release\plugins\ssl 中找到 $($copiedPlugins.Count) 个插件文件" -ForegroundColor Green
          }
        }
        
        # 检查并复制 Qt 网络插件
        if (Test-Path "$QtPlugins\networkinformation") {
          New-Item -ItemType Directory -Path "release\plugins\networkinformation" -Force | Out-Null
          Copy-Item "$QtPlugins\networkinformation\*" -Destination "release\plugins\networkinformation\" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "✓ 已复制 networkinformation 插件" -ForegroundColor Green
        }
        
        # 最终验证：确保所有必要的文件都存在
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "最终验证: 所有 SSL/TLS 支持文件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # 验证 OpenSSL DLL 文件
        $finalCrypto = Get-Item "release\libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        $finalSsl = Get-Item "release\libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($finalCrypto -and $finalSsl) {
          Write-Host "✓ OpenSSL DLL 文件:" -ForegroundColor Green
          Write-Host "    - $($finalCrypto.Name) ($([math]::Round($finalCrypto.Length/1KB, 2)) KB)" -ForegroundColor Green
          Write-Host "    - $($finalSsl.Name) ($([math]::Round($finalSsl.Length/1KB, 2)) KB)" -ForegroundColor Green
        } else {
          Write-Host "✗ OpenSSL DLL 文件缺失！" -ForegroundColor Red
          exit 1
        }
        
        # 验证 SSL/TLS 插件
        $sslPlugins = Get-ChildItem -Path "release\plugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
        $tlsPlugins = Get-ChildItem -Path "release\plugins\tls" -Filter "*.dll" -ErrorAction SilentlyContinue
        $totalPlugins = ($sslPlugins ? $sslPlugins.Count : 0) + ($tlsPlugins ? $tlsPlugins.Count : 0)
        
        if ($totalPlugins -gt 0) {
          Write-Host "✓ Qt SSL/TLS 插件 ($totalPlugins 个):" -ForegroundColor Green
          if ($sslPlugins) {
            foreach ($plugin in $sslPlugins) {
              Write-Host "    - [ssl] $($plugin.Name) ($([math]::Round($plugin.Length/1KB, 2)) KB)" -ForegroundColor Green
            }
          }
          if ($tlsPlugins) {
            foreach ($plugin in $tlsPlugins) {
              Write-Host "    - [tls] $($plugin.Name) ($([math]::Round($plugin.Length/1KB, 2)) KB)" -ForegroundColor Green
            }
          }
        } else {
          Write-Host "⚠ Qt SSL/TLS 插件缺失" -ForegroundColor Yellow
          Write-Host "   注意: 这对于某些 Qt 5.15.2 分发版是正常的" -ForegroundColor Yellow
          Write-Host "   Qt 5.15.2 主要依赖 OpenSSL DLL 文件（已复制）" -ForegroundColor Yellow
          Write-Host "   HTTPS 功能应该可以正常工作" -ForegroundColor Yellow
          Write-Host "   如果遇到问题，请参考文档手动添加 SSL 插件" -ForegroundColor Yellow
          # 不退出，允许构建继续，因为 OpenSSL DLL 文件已存在
        }
        
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "SSL/TLS 支持文件验证完成" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # 最终状态检查
        $finalSslPlugins = Get-ChildItem -Path "release\plugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
        $finalTlsPlugins = Get-ChildItem -Path "release\plugins\tls" -Filter "*.dll" -ErrorAction SilentlyContinue
        $totalFinalPlugins = ($finalSslPlugins ? $finalSslPlugins.Count : 0) + ($finalTlsPlugins ? $finalTlsPlugins.Count : 0)
        
        if ($totalFinalPlugins -gt 0) {
          Write-Host "✓ 所有 SSL/TLS 文件已就绪（包括 $totalFinalPlugins 个插件）" -ForegroundColor Green
        } else {
          Write-Host "⚠ SSL/TLS 插件缺失，但 OpenSSL DLL 已存在" -ForegroundColor Yellow
          Write-Host "  对于 Qt 5.15.2，这可能是正常的" -ForegroundColor Yellow
          Write-Host "  HTTPS 功能应该可以工作，如有问题请查看应用日志" -ForegroundColor Yellow
        }
    
    - name: Create portable package
      run: |
        # 创建便携版压缩包（包含所有依赖）
        Compress-Archive -Path release\* -DestinationPath DataUploadTool-Portable.zip -Force
        Write-Host "已创建便携版压缩包: DataUploadTool-Portable.zip" -ForegroundColor Green
        Write-Host "要创建单个 exe 文件，请使用 Enigma Virtual Box 或参考 PACKAGING.md" -ForegroundColor Yellow
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DataUploadTool-Windows-EXE
        path: |
          release/*
          DataUploadTool-Portable.*
        retention-days: 30

