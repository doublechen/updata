name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Qt 5.15.2
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1
    
    - name: Configure CMake
      run: |
        cmake -B build -S . `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt5_DIR" `
          -G "Visual Studio 17 2022" `
          -A x64
    
    - name: Build
      run: cmake --build build --config Release --parallel
    
    - name: Create release directory
      run: |
        mkdir release
    
    - name: Copy executable and resources
      run: |
        copy build\Release\DataUploadTool.exe release\
        if (Test-Path "logo.png") {
          copy logo.png release\
        }
        Write-Host "已复制可执行文件和资源文件" -ForegroundColor Green
    
    - name: Package with windeployqt
      working-directory: release
      run: |
        # 使用 windeployqt 部署所有依赖，包括网络和 SSL 插件
        # --ssl 标志确保 SSL 插件被正确部署
        & "$env:Qt5_DIR\bin\windeployqt.exe" --compiler-runtime --network --ssl DataUploadTool.exe
        Write-Host "windeployqt 完成，检查部署的文件..." -ForegroundColor Green
        
        # 检查关键文件是否存在
        if (Test-Path "platforms\qwindows.dll") {
          Write-Host "✓ platforms 目录已部署" -ForegroundColor Green
        } else {
          Write-Host "警告: platforms 目录未找到" -ForegroundColor Yellow
        }
        
        # 检查网络插件目录
        if (Test-Path "plugins\networkinformation") {
          Write-Host "✓ networkinformation 插件已部署" -ForegroundColor Green
        } else {
          Write-Host "警告: networkinformation 插件未找到" -ForegroundColor Yellow
        }
        
        # 检查 SSL 插件目录（关键！）
        if (Test-Path "plugins\ssl") {
          Write-Host "✓ SSL 插件目录已部署" -ForegroundColor Green
          Get-ChildItem -Path "plugins\ssl" -Filter "*.dll" | ForEach-Object {
            Write-Host "  - $($_.Name)" -ForegroundColor Cyan
          }
        } else {
          Write-Host "警告: SSL 插件目录未找到，将在后续步骤中手动复制" -ForegroundColor Yellow
        }
        
        # 列出所有插件目录
        Write-Host "已部署的插件目录:" -ForegroundColor Cyan
        if (Test-Path "plugins") {
          Get-ChildItem -Path "plugins" -Directory | ForEach-Object { 
            Write-Host "  - plugins\$($_.Name)" -ForegroundColor Cyan 
          }
        }
    
    - name: Copy OpenSSL DLL files
      run: |
        # 优先从项目的 dll 目录复制 OpenSSL DLL 文件
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "复制 OpenSSL DLL 文件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        $Copied = $false
        
        # 方法1: 优先从项目 dll/64 目录复制（64位版本，最可靠）
        if ((Test-Path "dll\64\libcrypto-1_1.dll") -and (Test-Path "dll\64\libssl-1_1.dll")) {
          Copy-Item "dll\64\libcrypto-1_1.dll" -Destination "release\" -Force
          Copy-Item "dll\64\libssl-1_1.dll" -Destination "release\" -Force
          Write-Host "已从项目 dll/64 目录复制 OpenSSL DLL (64位版本)" -ForegroundColor Green
          Write-Host "  - libcrypto-1_1.dll" -ForegroundColor Green
          Write-Host "  - libssl-1_1.dll" -ForegroundColor Green
          $Copied = $true
        } elseif ((Test-Path "dll\libcrypto-1_1.dll") -and (Test-Path "dll\libssl-1_1.dll")) {
          # 方法1b: 从 dll 目录复制（备用）
          Copy-Item "dll\libcrypto-1_1.dll" -Destination "release\" -Force
          Copy-Item "dll\libssl-1_1.dll" -Destination "release\" -Force
          Write-Host "已从项目 dll 目录复制 OpenSSL DLL" -ForegroundColor Green
          Write-Host "  - libcrypto-1_1.dll" -ForegroundColor Green
          Write-Host "  - libssl-1_1.dll" -ForegroundColor Green
          $Copied = $true
        } else {
          Write-Host "项目 dll 目录中未找到 OpenSSL DLL" -ForegroundColor Yellow
          
          # 方法2: 尝试从 Qt 目录复制
          $QtBin = "$env:Qt5_DIR\bin"
          Write-Host "尝试从 Qt 目录复制: $QtBin" -ForegroundColor Cyan
          
          $libcrypto = Get-ChildItem -Path $QtBin -Filter "libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          $libssl = Get-ChildItem -Path $QtBin -Filter "libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($libcrypto -and $libssl) {
            Copy-Item $libcrypto.FullName -Destination "release\" -Force
            Copy-Item $libssl.FullName -Destination "release\" -Force
            Write-Host "已从 Qt 目录复制 OpenSSL DLL" -ForegroundColor Green
            Write-Host "  - $($libcrypto.Name)" -ForegroundColor Green
            Write-Host "  - $($libssl.Name)" -ForegroundColor Green
            $Copied = $true
          }
        }
        
        # 验证 DLL 文件是否已复制
        if ($Copied) {
          $libcrypto = Get-ChildItem -Path "release" -Filter "libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          $libssl = Get-ChildItem -Path "release" -Filter "libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($libcrypto -and $libssl) {
            Write-Host "========================================" -ForegroundColor Green
            Write-Host "OpenSSL DLL 文件验证成功:" -ForegroundColor Green
            Write-Host "  - $($libcrypto.Name) ($([math]::Round($libcrypto.Length/1KB, 2)) KB)" -ForegroundColor Green
            Write-Host "  - $($libssl.Name) ($([math]::Round($libssl.Length/1KB, 2)) KB)" -ForegroundColor Green
            Write-Host "========================================" -ForegroundColor Green
            
            # 验证 DLL 文件架构（64位）
            Write-Host "验证 DLL 文件架构..." -ForegroundColor Cyan
            $fileInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($libcrypto.FullName)
            Write-Host "DLL 文件位置: $($libcrypto.FullName)" -ForegroundColor Cyan
          } else {
            Write-Host "警告: DLL 文件可能未正确复制" -ForegroundColor Yellow
            exit 1
          }
        } else {
          Write-Host "========================================" -ForegroundColor Red
          Write-Host "错误: 无法找到 OpenSSL DLL 文件" -ForegroundColor Red
          Write-Host "请确保项目 dll 目录包含 libcrypto-1_1.dll 和 libssl-1_1.dll" -ForegroundColor Red
          Write-Host "========================================" -ForegroundColor Red
          exit 1
        }
        
        # 检查并复制 Qt SSL 插件（关键！）
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "检查并复制 Qt SSL 插件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        $QtPlugins = "$env:Qt5_DIR\plugins"
        
        # Qt 5.15 需要 SSL 插件才能使用 OpenSSL
        if (Test-Path "$QtPlugins\ssl") {
          # 确保目标目录存在
          if (-not (Test-Path "release\plugins\ssl")) {
            New-Item -ItemType Directory -Path "release\plugins\ssl" -Force | Out-Null
            Write-Host "已创建 plugins\ssl 目录" -ForegroundColor Green
          }
          
          $sslPlugins = Get-ChildItem -Path "$QtPlugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($sslPlugins) {
            $copiedCount = 0
            foreach ($plugin in $sslPlugins) {
              $destPath = "release\plugins\ssl\$($plugin.Name)"
              Copy-Item $plugin.FullName -Destination $destPath -Force
              Write-Host "✓ 已复制 SSL 插件: $($plugin.Name)" -ForegroundColor Green
              $copiedCount++
            }
            Write-Host "共复制 $copiedCount 个 SSL 插件文件" -ForegroundColor Green
            
            # 验证复制的文件
            $copiedPlugins = Get-ChildItem -Path "release\plugins\ssl" -Filter "*.dll"
            if ($copiedPlugins.Count -gt 0) {
              Write-Host "验证: 在 release\plugins\ssl 中找到 $($copiedPlugins.Count) 个插件文件" -ForegroundColor Green
            } else {
              Write-Host "错误: SSL 插件文件复制后未找到" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "警告: Qt SSL 插件目录存在但未找到 DLL 文件: $QtPlugins\ssl" -ForegroundColor Yellow
            Write-Host "列出目录内容:" -ForegroundColor Yellow
            Get-ChildItem -Path "$QtPlugins\ssl" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.Name)" -ForegroundColor Yellow
            }
          }
        } else {
          Write-Host "错误: 未找到 Qt SSL 插件目录: $QtPlugins\ssl" -ForegroundColor Red
          Write-Host "这会导致 SSL/TLS 功能无法正常工作！" -ForegroundColor Red
          Write-Host "检查 Qt 插件目录是否存在:" -ForegroundColor Yellow
          if (Test-Path $QtPlugins) {
            Write-Host "Qt 插件目录存在: $QtPlugins" -ForegroundColor Yellow
            Get-ChildItem -Path $QtPlugins -Directory | ForEach-Object {
              Write-Host "  - $($_.Name)" -ForegroundColor Yellow
            }
          } else {
            Write-Host "Qt 插件目录不存在: $QtPlugins" -ForegroundColor Red
          }
          exit 1
        }
        
        # 检查并复制 Qt 网络插件
        if (Test-Path "$QtPlugins\networkinformation") {
          New-Item -ItemType Directory -Path "release\plugins\networkinformation" -Force | Out-Null
          Copy-Item "$QtPlugins\networkinformation\*" -Destination "release\plugins\networkinformation\" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "✓ 已复制 networkinformation 插件" -ForegroundColor Green
        }
        
        # 最终验证：确保所有必要的文件都存在
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "最终验证: 所有 SSL/TLS 支持文件" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # 验证 OpenSSL DLL 文件
        $finalCrypto = Get-Item "release\libcrypto*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        $finalSsl = Get-Item "release\libssl*.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($finalCrypto -and $finalSsl) {
          Write-Host "✓ OpenSSL DLL 文件:" -ForegroundColor Green
          Write-Host "    - $($finalCrypto.Name) ($([math]::Round($finalCrypto.Length/1KB, 2)) KB)" -ForegroundColor Green
          Write-Host "    - $($finalSsl.Name) ($([math]::Round($finalSsl.Length/1KB, 2)) KB)" -ForegroundColor Green
        } else {
          Write-Host "✗ OpenSSL DLL 文件缺失！" -ForegroundColor Red
          exit 1
        }
        
        # 验证 SSL 插件
        $sslPlugins = Get-ChildItem -Path "release\plugins\ssl" -Filter "*.dll" -ErrorAction SilentlyContinue
        if ($sslPlugins -and $sslPlugins.Count -gt 0) {
          Write-Host "✓ Qt SSL 插件 ($($sslPlugins.Count) 个):" -ForegroundColor Green
          foreach ($plugin in $sslPlugins) {
            Write-Host "    - $($plugin.Name) ($([math]::Round($plugin.Length/1KB, 2)) KB)" -ForegroundColor Green
          }
        } else {
          Write-Host "✗ Qt SSL 插件缺失！这会导致 SSL/TLS 功能无法正常工作！" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "所有 SSL/TLS 支持文件验证通过！" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Green
    
    - name: Create portable package
      run: |
        # 创建便携版压缩包（包含所有依赖）
        Compress-Archive -Path release\* -DestinationPath DataUploadTool-Portable.zip -Force
        Write-Host "已创建便携版压缩包: DataUploadTool-Portable.zip" -ForegroundColor Green
        Write-Host "要创建单个 exe 文件，请使用 Enigma Virtual Box 或参考 PACKAGING.md" -ForegroundColor Yellow
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DataUploadTool-Windows-EXE
        path: |
          release/*
          DataUploadTool-Portable.*
        retention-days: 30

